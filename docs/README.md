# dekita_calendar - 習慣トラッキングアプリ ドキュメント

## 概要

dekita_calendarは習慣の継続をサポートするFlutterアプリです。
ユーザーは日々の習慣を登録し、達成状況を管理できます。
バッジシステムにより、継続のモチベーションを維持します。

## 現在の実装状況

### バッジシステム（実装済み）

習慣の継続達成に応じてバッジを獲得できる機能。

#### バッジ種類（5種類）

| バッジ | 条件 | 色 | アイコン |
|--------|------|-----|----------|
| ブロンズ | 3日連続 | 銅色 | ⭐️ 星の輪郭 |
| シルバー | 7日連続 | 銀色 | ⭐ 塗りつぶし星 |
| ゴールド | 30日連続 | 金色 | ✨ 複数の星 |
| プラチナ | 100日連続 | プラチナ色 | 🎖️ メダル |
| ダイヤモンド | 365日連続 | 水色 | 🏆 プレミアムバッジ |

#### 現在の仕様

- **計算方法**: 全習慣の連続達成日数
  - その日に予定されている全ての習慣を完了で+1日
  - 1つでもスキップすると連続リセット
  - 今日が未完了の場合、昨日までの連続を保持

- **バッジ獲得演出**:
  - 流れ星アニメーション（15個、1.8秒）
  - 左上から右下へ斜めに流れる
  - バッジアイコンの回転＆拡大表示
  - 「Badge Get!」ダイアログ

- **バッジの永続化**:
  - 一度獲得したバッジは連続が途切れても保持
  - SharedPreferencesに保存

#### ファイル構成

```
lib/
├── models/
│   └── badge.dart           # バッジデータモデル
├── services/
│   └── badge_service.dart   # バッジ計算・管理ロジック
├── widgets/
│   ├── badge_widget.dart           # バッジ表示UI
│   └── shooting_star_animation.dart # 獲得演出
└── views/
    └── home_view.dart       # ホーム画面（バッジ表示含む）
```

### UI/UX

- **ホーム画面**:
  - バッジコレクション表示（明るい背景で視認性向上）
  - 連続達成日数の表示
  - 次の目標バッジの表示
  - 習慣が未登録の場合は案内メッセージ

- **デバッグパネル**（デバッグビルドのみ）:
  - 連続日数の手動設定
  - バッジ獲得テスト
  - 進捗リセット機能

## 既知の問題と制限

### 曜日指定習慣の問題（**重要**）

現在の日数ベースの計算には重大な問題があります：

- **毎日の習慣**: 365日で最高ランク（約1年）
- **週1回の習慣**（例：月曜のみ）: 365日 = **7年かかる**

→ 習慣の頻度によって達成難易度が大きく異なり、不公平

## 次回の実装予定（週単位システムへの移行）

### 目的

曜日指定習慣でも公平に評価されるシステムへの変更。

### 新しい仕様

**週クリア条件:**
- その週（月曜〜日曜）に予定されている全ての習慣を完了

**新しいバッジ条件:**
- ブロンズ: 1週連続
- シルバー: 2週連続
- ゴールド: 4週連続（約1ヶ月）
- プラチナ: 12週連続（約3ヶ月）
- ダイヤモンド: 52週連続（1年）

**メリット:**
- 毎日の習慣でも週1の習慣でも同じ期間で評価
- 「1週間頑張った」という単位が直感的
- 週1習慣でも1年で最高ランク到達可能

### 実装タスク

詳細は `badge_weekly_system.md` を参照。

#### 1. モデルの変更
- [ ] `AchievementBadge` に `requiredWeeks` を追加（または `requiredDays` を置き換え）
- [ ] `BadgeProgress` はそのまま使用（`currentStreak` は週数を意味するように）

#### 2. 計算ロジックの実装
- [ ] `badge_service.dart` に週単位計算メソッドを実装
  - `calculateWeeklyStreak(List<Habit> habits)`: 週連続数を計算
  - `_isWeekCompleted(List<Habit> habits, DateTime weekStart)`: 週クリア判定
  - `_getWeekStart(DateTime date)`: 週の開始日（日曜）を取得

#### 3. UIの更新
- [ ] `badge_widget.dart`: 表示を「○日」→「○週」に変更
- [ ] ヘッダーを「連続達成 ○日」→「○週目チャレンジ中」に変更
- [ ] バッジ下の表示を「3日」→「1週」などに変更

#### 4. デバッグ機能の更新
- [ ] デバッグパネルで週数を設定できるように変更

#### 5. テスト
- [ ] 毎日習慣で1週クリア
- [ ] 週1習慣で1週クリア
- [ ] 複数習慣で1週クリア
- [ ] 週途中の表示確認
- [ ] 連続リセットの動作確認

### 実装の開始方法

次回セッション開始時に「続きをお願いします」と言われたら：

1. `docs/badge_weekly_system.md` を参照
2. 上記タスクリストに従って実装
3. まず `badge_service.dart` の週計算ロジックから着手

## その他のドキュメント

- `badge_animation_improvements.md`: バッジ演出の改良メモ（将来的な差別化案）
- `badge_weekly_system.md`: 週単位システムの詳細設計

## 開発メモ

- Flutterバージョン: 3.7.3
- 状態管理: ChangeNotifier（HabitController）
- ローカルストレージ: SharedPreferences
- アニメーション: AnimationController + CustomPainter

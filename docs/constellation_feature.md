# 星座機能 設計ドキュメント

## コンセプト

> 毎日習慣を続けるたびに、あなたの夜空に星がひとつ灯る。
> 星は少しずつ星座を形づくり、あなたの努力の軌跡になる。

習慣の継続をビジュアル的に表現し、長期的なモチベーションを維持するための機能。

## 主要機能

1. **星の獲得**: 習慣を達成するたびに星が灯る
2. **星座の完成**: 一定日数の連続達成で星座が完成（星が線で結ばれる）
3. **流れ星演出**: 星座完成時や節目の達成時に流れ星アニメーション
4. **星座図鑑**: 完成した星座の記録と閲覧

## フェーズ計画

### Phase 1（シンプル版）- ✅ 完了

**目標**: 基本的な星座システムの実装

- [x] データモデル作成
  - 星座データ構造
  - 星の座標管理
  - 進捗状態の保存
- [x] 星座データ定義
  - 初期星座1つ（カシオペア座 - 5つ星）
  - 星の座標と線の定義
- [x] UI実装
  - ホーム画面上部に星座表示エリア
  - CustomPainter による星と線の描画
  - コンパクト表示（150px）
- [x] アニメーション
  - 星が灯るアニメーション（キラキラエフェクト）
  - 星座完成時の流れ星演出（簡易版）
- [x] ロジック実装
  - 連続達成日数の計算
  - 星の解放条件判定
  - 星座完成判定

**達成条件**:
- ✅ 5日連続達成で1つの星座が完成する
- ✅ 完成時に流れ星演出が表示される

### Phase 2（拡張版）- 未着手

**目標**: より豊かな体験の提供

- [ ] 複数星座の実装（3-5種類）
- [ ] 星座専用画面の作成
  - 全画面で夜空を表示
  - 完成した星座一覧
  - タップでズーム・詳細表示
- [ ] 高度なアニメーション
  - Lottie アニメーション導入検討
  - 星のキラキラエフェクト
  - より美しい流れ星演出
- [ ] 季節対応
  - 季節ごとの夜空の色変化
  - 季節に合わせた星座セレクト

### Phase 3（アドバンス版）- 未着手

**目標**: 長期継続のための要素追加

- [ ] 12星座コンプリート要素
- [ ] 星座図鑑機能
- [ ] 願い事メモ機能（星座完成時に記録）
- [ ] 実績システムとの連携
- [ ] SNSシェア機能

## 技術仕様

### データ構造

```dart
// 星座の定義
class Constellation {
  final String id;
  final String name;
  final List<StarPosition> stars;      // 星の座標リスト
  final List<StarConnection> lines;    // 星を結ぶ線
  final int requiredDays;              // 完成に必要な日数
}

// 星の位置
class StarPosition {
  final double x;  // 0.0 - 1.0 (相対座標)
  final double y;  // 0.0 - 1.0 (相対座標)
  final int unlockDay;  // この星が解放される日数
}

// 星座の進捗状態
class ConstellationProgress {
  final String constellationId;
  final int currentStreak;          // 現在の連続日数
  final List<int> unlockedStars;    // 解放済みの星インデックス
  final bool isCompleted;           // 完成済みフラグ
  final DateTime? completedAt;      // 完成日時
}
```

### ファイル構成

```
lib/
├── models/
│   └── constellation.dart          # データモデル
├── services/
│   └── constellation_service.dart  # 星座管理サービス
├── widgets/
│   ├── constellation_widget.dart   # 星座表示ウィジェット
│   └── shooting_star_animation.dart # 流れ星アニメーション
└── views/
    └── constellation_detail_view.dart  # 星座詳細画面（Phase 2）
```

### データ永続化

SharedPreferences を使用:
- キー: `constellation_progress`
- 値: JSON形式の進捗データ

## 進捗記録

### 2025-10-09（続き）

**バグ修正とUI改善**
- [x] カレンダー画面でも星座進捗が更新されるように修正
  - `lib/views/calendar_view.dart`に星座更新ロジックを追加
  - カレンダーとホーム両方で習慣完了時に星が増えるように

- [x] お祝いアニメーションの表示タイミング改善
  - カレンダー画面では進捗更新のみ、アニメーション表示なし
  - ホーム画面を開いた時にお祝い表示（より自然なUX）
  - `celebrationShown`フラグを追加して重複表示を防止

- [x] 流れ星の視認性改善
  - 背景を半透明の黒（`Colors.black54`）に変更
  - 白い画面でもはっきり見えるように

- [x] 画面フリーズ問題の修正
  - HabitControllerのリスナーによる無限ループを解消
  - `_isUpdating`フラグで同時更新を防止
  - デバッグログを追加

- [x] 未完了時にお祝いが出る問題を修正
  - 初めて5日連続達成した時のみお祝い表示
  - 6日→5日のような減少では表示しない
  - 連続が途切れた（0日）後の再達成は新しい達成として扱う

**確認された問題と対処**
1. ❌ カレンダー画面で習慣完了しても星が増えない
   → ✅ 修正: CalendarViewに星座更新ロジック追加

2. ❌ 白背景で流れ星が見えない
   → ✅ 修正: 背景を`Colors.black54`に変更

3. ❌ 画面がフリーズする
   → ✅ 修正: 無限ループを防止、更新フラグ追加

4. ❌ 未完了にした時にお祝いが表示される
   → ✅ 修正: お祝い表示条件を厳格化

**デバッグログの追加**
- `🌟` 星座読み込み/更新のログ
- `📱` アプリライフサイクルのログ
- `🎉` お祝い表示のログ
- これらのログでトラブルシューティングが容易に

### 2025-10-08

**設計・計画**
- [x] 星座機能の設計ドキュメント作成
- [x] Phase 1 実装計画の策定

**Phase 1 実装完了**
- [x] データモデル作成（`lib/models/constellation.dart`）
  - StarPosition, StarConnection, Constellation, ConstellationProgress
  - `celebrationShown`フラグ追加（お祝い重複防止）
- [x] 星座管理サービス作成（`lib/services/constellation_service.dart`）
  - カシオペア座データ定義
  - 進捗計算・保存ロジック
  - 連続達成日数の計算
  - お祝い表示判定ロジック
- [x] 星座表示ウィジェット作成（`lib/widgets/constellation_widget.dart`）
  - CustomPainter による星と線の描画
  - キラキラアニメーション
  - 夜空の背景グラデーション
- [x] 流れ星アニメーション作成（`lib/widgets/shooting_star_animation.dart`）
  - 3つの流れ星の軌跡
  - 完成メッセージ表示
  - 半透明背景で視認性改善
- [x] ホーム画面への組み込み（`lib/views/home_view.dart`）
  - 星座ウィジェットの表示
  - 習慣完了時の進捗更新
  - 完成時の流れ星演出トリガー
  - 無限ループ防止とライフサイクル管理
- [x] カレンダー画面への組み込み（`lib/views/calendar_view.dart`）
  - 習慣完了時の進捗更新
  - ホーム画面でのお祝い表示との連携

**次のステップ（次回セッション）**
- [ ] さらなるバグ確認とテスト
- [ ] 細かいUI調整（アニメーション速度、星の配置など）
- [ ] Phase 2 の検討開始（複数星座、専用画面など）
- [ ] ユーザーフィードバック収集

**既知の課題**
- まだ他のバグが潜んでいる可能性あり（要テスト）
- アニメーションの速度や演出の調整が必要かも

---

## 備考

- シンプルさと美しさのバランスを重視
- パフォーマンスに配慮（CustomPainter の最適化）
- ダークモード対応を考慮した色設計
- アクセシビリティ（色弱対応など）は Phase 2 で検討
